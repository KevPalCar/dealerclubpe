<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cursos - DealerClub</title>
    
    <!-- Enlaces a tus hojas de estilo personalizadas (Rutas CORRECTAS) -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/cursos.css"> 
    
    <!-- NOTA IMPORTANTE: Las importaciones de fuentes y Font Awesome DEBEN estar en tu archivo assets/css/main.css. -->
    <!-- Font Awesome para iconos (si aún no está en main.css) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- ANNOUNCE BAR -->
    <div id="announce-bar" class="announce-bar" style="display: none;">
        <p id="announce-text"></p>
        <button id="close-announce-bar"><i class="fas fa-times"></i></button>
    </div>

    <!-- HEADER: Este será el contenedor principal con la imagen de fondo que abarca todo.
          Contiene la barra de navegación y el contenido principal del hero. -->
    <header class="hero-section"> 
        <nav class="navbar">
            <div class="logo">
                <a href="../index.html">DealerClub</a> <!-- Ruta para volver a la página de inicio -->
            </div>
            <ul class="nav-menu">
                <li><a href="../index.html">Inicio</a></li> 
                <li><a href="cursos.html" class="current">Cursos</a></li>
                <li><a href="servicios.html">Servicios</a></li>
                <li><a href="nosotros.html">Nosotros</a></li>
                <!-- Nuevo enlace al dashboard de estudiante / login -->
                <li><a href="login.html" id="student-access-link">Iniciar Sesión</a></li>
            </ul>
        </nav>

        <!-- Contenido del hero (título, párrafo, botones) -->
        <div class="hero-content text-center">
            <h1>Conviértete en un Dealer de Élite</h1>
            <p>Nuestros programas de formación te guiarán desde lo básico hasta la maestría en el arte del juego. ¡Tu carrera empieza aquí!</p>
            <div class="hero-ctas">
                <a href="#paquetes-formacion" class="btn btn-secondary">Explora nuestros niveles</a>
            </div>
        </div>
    </header>

    <main>
        <!-- Sección de Propuesta de Paquetes de Formación Intensiva -->
        <section id="paquetes-formacion" class="section-dark section-padded">
            <div class="container">
                <h2>Propuesta de Paquetes de Formación Intensiva</h2>
                <!-- Aquí se cargarán los cursos dinámicamente desde Firestore -->
                <div id="courses-grid-container" class="paquete-grid">
                    <!-- Mensaje de carga mientras se obtienen los cursos -->
                    <div id="loading-courses" style="text-align: center; color: #ffc107; font-size: 1.2em; padding: 50px;">
                        Cargando cursos...
                    </div>
                </div>
                <div id="no-courses-message" class="info-message" style="display: none; text-align: center; color: #ffc107; font-size: 1.2em; padding: 50px;">
                    No hay cursos disponibles en este momento.
                </div>
            </div>
        </section>
        
        <!-- Sección de Consideraciones Adicionales (con imagen de fondo) -->
        <section class="full-screen-section content-section with-bg-image" id="consideraciones-adicionales">
            <div class="content-wrapper">
                <h2 class="section-title">Consideraciones Adicionales</h2>
                <div class="consideraciones-grid">
                    <div class="consideracion-item">
                        <i class="fas fa-clock"></i>
                        <h4>Horarios Flexibles</h4>
                        <p>Diseñamos horarios que se adaptan a tu ritmo de vida, con clases disponibles por la mañana, tarde y fines de semana.</p>
                    </div>
                    <div class="consideracion-item">
                        <i class="fas fa-users"></i>
                        <h4>Grupos Reducidos</h4>
                        <p>Nuestras clases se imparten en grupos pequeños para asegurar una atención personalizada y una práctica intensa.</p>
                    </div>
                    <div class="consideracion-item">
                        <i class="fas fa-gamepad"></i>
                        <h4>Práctica Constante</h4>
                        <p>Contamos con mesas, fichas y barajas profesionales para que practiques en un entorno real de casino.</p>
                    </div>
                    <div class="consideracion-item">
                        <i class="fas fa-certificate"></i>
                        <h4>Certificación Oficial</h4>
                        <p>Al finalizar el programa, obtienes un certificado que valida tus habilidades y te prepara para el mundo laboral.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer: Consistente con el resto del sitio -->
    <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-info">
                <h3>DealerClub</h3>
                <p>Tu talento, es nuestro estandar.</p>
            </div>
            <div class="footer-contact">
                <h3>Contacto</h3>
                <p>WhatsApp: +51 936437502</p>
                <p>Dirección: Calle Los Mirtos 145 / Independencia</p>
            </div>
            <div class="footer-social">
                <h3>Síguenos</h3>
                <a href="https://www.instagram.com/dealerclub.pe/" target="_blank" rel="noopener noreferrer">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png" alt="Instagram" class="social-icon">
                </a>
            </div>
            <!-- ELIMINADO: Enlace discreto al panel de administración -->
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 DealerClub. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- Icono flotante de WhatsApp (asegúrate de que este esté en todas tus páginas) -->
    <a href="https://wa.me/51936437502?text=Hola%2C%20me%20gustar%C3%ADa%20obtener%20m%C3%A1s%20informaci%C3%B3n." class="whatsapp-float" target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Nuevo Modal de Inscripción a Cursos -->
    <div id="enrollCourseModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeEnrollModalBtn">&times;</span>
            <h2>Inscripción al Curso</h2>
            <p id="enrollCourseName"></p> <!-- Para mostrar el nombre del curso seleccionado -->
            <form id="enrollmentForm">
                <input type="hidden" id="enrollCourseId" name="courseId">
                <div class="form-group">
                    <label for="enrollFullName">Nombre Completo:</label>
                    <input type="text" id="enrollFullName" name="fullName" required>
                </div>
                <div class="form-group">
                    <label for="enrollEmail">Correo Electrónico:</label>
                    <input type="email" id="enrollEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="enrollPhone">Teléfono (WhatsApp):</label>
                    <input type="tel" id="enrollPhone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="enrollComments">Comentarios o Preguntas:</label>
                    <textarea id="enrollComments" name="comments" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" id="submitEnrollmentBtn">Confirmar Inscripción</button>
                <div id="enrollFormMessage" class="form-message"></div>
            </form>
        </div>
    </div>

    <!-- SCRIPT DE INICIALIZACIÓN DE FIREBASE Y LÓGICA DE LA PÁGINA (mantener al final del body) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Usar las variables globales del entorno Canvas, con fallbacks para desarrollo local
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyA3YsyUDmLeAvvgWwvCnjeJt-HbGGk--PY", // Reemplaza con tu API Key real
            authDomain: "dealerclubpe.firebaseapp.com", // Reemplaza con tu Auth Domain real
            projectId: "dealerclubpe", // Reemplaza con tu Project ID real
            storageBucket: "dealerclubpe.firebasestorage.app", // Reemplaza con tu Storage Bucket real
            messagingSenderId: "330568352415", // Reemplaza con tu Messaging Sender ID real
            appId: "1:330568352415:web:9fcd7651698bfafac998aa", // Reemplaza con tu App ID real
            measurementId: "G-PF3W9NDSDP" // Reemplaza con tu Measurement ID real
        };
        // initialAuthToken no se usará directamente para login en esta página, pero lo mantenemos para consistencia
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            const studentAccessLink = document.getElementById('student-access-link');
            const coursesGridContainer = document.getElementById('courses-grid-container');
            const loadingCoursesMessage = document.getElementById('loading-courses');
            const noCoursesMessage = document.getElementById('no-courses-message');

            const enrollCourseModal = document.getElementById('enrollCourseModal');
            const closeEnrollModalBtn = document.getElementById('closeEnrollModalBtn');
            const enrollCourseName = document.getElementById('enrollCourseName');
            const enrollmentForm = document.getElementById('enrollmentForm');
            const enrollCourseId = document.getElementById('enrollCourseId');
            const enrollFullName = document.getElementById('enrollFullName');
            const enrollEmail = document.getElementById('enrollEmail');
            const enrollPhone = document.getElementById('enrollPhone');
            const enrollComments = document.getElementById('enrollComments');
            const enrollFormMessage = document.getElementById('enrollFormMessage');

            const announceBar = document.getElementById('announce-bar');
            const announceTextElement = document.getElementById('announce-text');
            const closeAnnounceBarBtn = document.getElementById('close-announce-bar');

            let selectedCourseId = null; // Para almacenar el ID del curso al que el usuario se está inscribiendo

            const showFormMessage = (messageElement, message, type) => {
                messageElement.textContent = message;
                messageElement.className = `form-message ${type}`; // 'success', 'error', 'loading'
                setTimeout(() => messageElement.textContent = '', 3000); // Limpiar mensaje después de 3 segundos
            };

            const openModal = (modalElement) => {
                modalElement.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            };

            const closeModal = (modalElement) => {
                modalElement.style.display = 'none';
                document.body.style.overflow = 'auto';
            };

            // --- Listener para el estado de autenticación (Header Link) ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Si el usuario está logueado, verifica su rol
                    const userRoleRef = doc(db, `/artifacts/${appId}/public/data/user_roles/${user.uid}`);
                    try {
                        const userRoleSnap = await getDoc(userRoleRef);
                        if (userRoleSnap.exists()) {
                            const role = userRoleSnap.data().role;
                            if (role === 'admin') {
                                studentAccessLink.textContent = 'Panel Admin';
                                studentAccessLink.href = 'admin.html'; // Ruta relativa
                            } else if (role === 'student') {
                                studentAccessLink.textContent = 'Mi Dashboard';
                                studentAccessLink.href = 'student_dashboard.html'; // Ruta relativa
                            } else {
                                studentAccessLink.textContent = 'Iniciar Sesión';
                                studentAccessLink.href = 'login.html';
                                console.warn("Cursos.html: Rol de usuario desconocido. Cerrando sesión.");
                                await signOut(auth); // Cerrar sesión si el rol es desconocido
                            }
                        } else {
                            // No se encontró el documento de rol, tratar como no logueado o rol desconocido
                            studentAccessLink.textContent = 'Iniciar Sesión';
                            studentAccessLink.href = 'login.html';
                            console.warn("Cursos.html: Documento de rol no encontrado. Cerrando sesión.");
                            await signOut(auth); // Cerrar sesión
                        }
                    } catch (error) {
                        console.error("Cursos.html: Error al obtener el rol del usuario:", error);
                        studentAccessLink.textContent = 'Iniciar Sesión';
                        studentAccessLink.href = 'login.html';
                        await signOut(auth); // Cerrar sesión en caso de error
                    }
                } else {
                    // No hay usuario logueado
                    studentAccessLink.textContent = 'Iniciar Sesión';
                    studentAccessLink.href = 'login.html';
                }
            });

            // --- Lógica para cargar cursos dinámicamente ---
            const loadCourses = () => {
                if (!db || !appId) {
                    console.error("Cursos.html: Firebase Firestore no está inicializado.");
                    loadingCoursesMessage.style.display = 'none';
                    noCoursesMessage.textContent = 'Error: No se pudo cargar la base de datos de cursos.';
                    noCoursesMessage.style.display = 'block';
                    return;
                }

                const coursesCollectionRef = collection(db, `/artifacts/${appId}/public/data/courses`);
                
                // Usar onSnapshot para actualizaciones en tiempo real
                onSnapshot(coursesCollectionRef, (querySnapshot) => {
                    coursesGridContainer.innerHTML = ''; // Limpiar contenido previo
                    loadingCoursesMessage.style.display = 'none'; // Ocultar mensaje de carga

                    if (querySnapshot.empty) {
                        noCoursesMessage.style.display = 'block';
                        return;
                    }
                    noCoursesMessage.style.display = 'none';

                    const courses = [];
                    querySnapshot.docs.forEach(doc => {
                        courses.push({ id: doc.id, ...doc.data() });
                    });

                    // Ordenar cursos por el campo 'order'
                    courses.sort((a, b) => (a.order || 999) - (b.order || 999));

                    courses.forEach(course => {
                        const courseCard = document.createElement('div');
                        courseCard.className = 'paquete-card';
                        
                        // Generar la clase de estado dinámica
                        const statusClass = course.status ? `status-${course.status.toLowerCase().replace(/\s/g, '-')}` : 'status-default';

                        courseCard.innerHTML = `
                            <span class="course-status ${statusClass}">${course.status || 'N/A'}</span>
                            <h3>${course.name || 'Curso Sin Nombre'}</h3>
                            <p>${course.description || 'Descripción no disponible.'}</p>
                            <p class="price">${course.price || 'N/A'}</p>
                            <ul>
                                <li><strong>Horario:</strong> ${course.schedule || 'N/A'}</li>
                                <li><strong>Duración:</strong> ${course.duration || 'N/A'}</li>
                                <li><strong>Juegos:</strong> ${Array.isArray(course.gamesIncluded) ? course.gamesIncluded.join(', ') : (course.gamesIncluded || 'N/A')}</li>
                            </ul>
                            <button class="btn btn-primary enroll-btn" data-course-id="${course.id}" data-course-name="${course.name}">Inscribirse</button>
                        `;
                        coursesGridContainer.appendChild(courseCard);
                    });

                    // Añadir event listeners a los botones de inscripción
                    document.querySelectorAll('.enroll-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            selectedCourseId = event.target.dataset.courseId;
                            const courseName = event.target.dataset.courseName;
                            enrollCourseName.textContent = `Curso: ${courseName}`;
                            enrollCourseId.value = selectedCourseId; // Guardar el ID en un campo oculto del formulario
                            enrollmentForm.reset(); // Limpiar formulario
                            showFormMessage(enrollFormMessage, '', ''); // Limpiar mensajes anteriores
                            openModal(enrollCourseModal);
                        });
                    });

                }, (error) => {
                    console.error("Cursos.html: Error al cargar cursos:", error);
                    loadingCoursesMessage.style.display = 'none';
                    noCoursesMessage.textContent = `Error al cargar los cursos: ${error.message}`;
                    noCoursesMessage.style.display = 'block';
                });
            };

            // --- Lógica del Modal de Inscripción ---
            closeEnrollModalBtn.addEventListener('click', () => closeModal(enrollCourseModal));

            window.addEventListener('click', (event) => {
                if (event.target === enrollCourseModal) {
                    closeModal(enrollCourseModal);
                }
            });

            enrollmentForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                showFormMessage(enrollFormMessage, 'Enviando inscripción...', 'loading');

                const enrollmentData = {
                    courseId: enrollCourseId.value,
                    courseName: enrollCourseName.textContent.replace('Curso: ', ''), // Obtener nombre limpio
                    fullName: enrollFullName.value,
                    email: enrollEmail.value,
                    phone: enrollPhone.value,
                    comments: enrollComments.value,
                    timestamp: new Date(),
                    status: 'Pendiente' // Estado inicial de la inscripción
                };

                try {
                    if (!db || !appId) {
                        throw new Error("Firebase Firestore no está inicializado.");
                    }
                    const enrollmentsCollectionRef = collection(db, `/artifacts/${appId}/public/data/course_enrollments`);
                    await addDoc(enrollmentsCollectionRef, enrollmentData);
                    showFormMessage(enrollFormMessage, 'Inscripción enviada con éxito. ¡Pronto nos pondremos en contacto!', 'success');
                    enrollmentForm.reset();
                    setTimeout(() => closeModal(enrollCourseModal), 2000); // Cerrar modal después de 2 segundos
                } catch (error) {
                    console.error("Cursos.html: Error al enviar la inscripción:", error);
                    showFormMessage(enrollFormMessage, `Error al enviar la inscripción: ${error.message}`, 'error');
                }
            });

            // --- Lógica para el Announce Bar ---
            if (db && appId) {
                const announceDocRef = doc(db, `/artifacts/${appId}/public/data/config/announceBar`);

                onSnapshot(announceDocRef, (docSnapshot) => {
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        if (data.status === 'active' && data.text) {
                            announceTextElement.textContent = data.text;
                            announceBar.style.display = 'flex';
                        } else {
                            announceBar.style.display = 'none';
                        }
                    } else {
                        announceBar.style.display = 'none';
                        console.log("Cursos.html: Documento 'announceBar' no encontrado en Firestore.");
                    }
                }, (error) => {
                    console.error("Cursos.html: Error al escuchar el announce bar desde Firestore:", error);
                    announceBar.style.display = 'none';
                });
            } else {
                console.error("Cursos.html: Firebase Firestore no está completamente inicializado para el announce bar.");
                announceBar.style.display = 'none';
            }

            closeAnnounceBarBtn.addEventListener('click', () => {
                announceBar.style.display = 'none';
            });

            // Cargar los cursos al inicio
            loadCourses();
        });
    </script>
</body>
</html>
