<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Estudiante - DealerClub</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/student_dashboard.css">
    <!-- Font Awesome para iconos si es necesario -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header class="dashboard-header">
        <div class="logo">
            <a href="../index.html">DealerClub</a>
        </div>
        <nav class="dashboard-nav">
            <ul>
                <li><a href="#" id="dashboard-link" class="current">Mi Dashboard</a></li>
                <li><a href="#" id="logout-btn">Cerrar Sesión</a></li>
                <!-- El enlace de Admin Panel se manejará con lógica JavaScript -->
                <li id="admin-panel-link-container" style="display: none;"><a href="admin.html" class="admin-link" title="Panel de Administración"><i class="fas fa-user-circle"></i></a></li>
            </ul>
        </nav>
    </header>

    <main class="dashboard-main">
        <section id="welcome-section" class="dashboard-container">
            <h2 id="welcome-message">Bienvenido/a, Estudiante!</h2>
            <p>Este es tu panel de control personalizado.</p>
            <div id="auth-status-message" class="message">Verificando estado de la sesión...</div>

            <div class="dashboard-content">
                <h3>Mis Cursos Inscritos</h3>
                <div id="enrolled-courses-list" class="courses-list">
                    <p id="loading-enrolled-courses">Cargando cursos...</p>
                    <p id="no-enrolled-courses" style="display: none;">No estás inscrito/a en ningún curso aún.</p>
                </div>

                <h3>Mi Progreso</h3>
                <div id="student-progress">
                    <p>Progreso del curso y notas se mostrarán aquí.</p>
                </div>

                <h3>Notas del Administrador</h3>
                <div id="admin-notes">
                    <p>Notas y tareas asignadas por el administrador.</p>
                </div>
            </div>
        </section>
    </main>

    <footer class="dashboard-footer">
        <p>&copy; 2025 DealerClub. Todos los derechos reservados.</p>
    </footer>

    <!-- SCRIPT DE INICIALIZACIÓN DE FIREBASE Y LÓGICA DEL DASHBOARD DEL ESTUDIANTE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Estas variables se usarán para la inicialización y rutas de Firestore
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyA3YsyUDmLeAvvgWwvCnjeJt-HbGGk--PY", 
            authDomain: "dealerclubpe.firebaseapp.com",
            projectId: "dealerclubpe",
            storageBucket: "dealerclubpe.firebasestorage.app",
            messagingSenderId: "330568352415",
            appId: "1:330568352415:web:9fcd7651698bfafac998aa",
            measurementId: "G-PF3W9NDSDP"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

        // Inicialización de Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- LÓGICA CLIENTE DE STUDENT_DASHBOARD.JS (MOVIDA DIRECTAMENTE AQUÍ) ---
        document.addEventListener('DOMContentLoaded', () => {
            const welcomeMessage = document.getElementById('welcome-message');
            const authStatusMessage = document.getElementById('auth-status-message');
            const logoutBtn = document.getElementById('logout-btn');
            const enrolledCoursesList = document.getElementById('enrolled-courses-list');
            const loadingEnrolledCourses = document.getElementById('loading-enrolled-courses');
            const noEnrolledCourses = document.getElementById('no-enrolled-courses');
            const adminPanelLinkContainer = document.getElementById('admin-panel-link-container');

            let currentUserId = null;
            let unsubscribeEnrollments = null; // Para el listener de onSnapshot

            const showAuthStatus = (message, type) => {
                authStatusMessage.textContent = message;
                authStatusMessage.className = `message ${type}`; // 'loading', 'success', 'error'
            };

            // --- Listener para el estado de autenticación ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    showAuthStatus('Sesión activa. Verificando rol...', 'loading');
                    
                    const userRoleRef = doc(db, `/artifacts/${appId}/public/data/user_roles/${user.uid}`);
                    try {
                        const userRoleSnap = await getDoc(userRoleRef);
                        if (userRoleSnap.exists()) {
                            const role = userRoleSnap.data().role;
                            if (role === 'student') {
                                welcomeMessage.textContent = `¡Bienvenido/a, ${user.email}!`;
                                showAuthStatus('Sesión iniciada como estudiante.', 'success');
                                console.log("Student Dashboard: Usuario es estudiante. Cargando dashboard.");
                                loadEnrolledCourses(user.uid);
                                // Mostrar el enlace al panel de administración si el usuario es un administrador
                                // (aunque esté en el dashboard de estudiante, si tiene rol de admin, el enlace aparece)
                                if (userRoleSnap.data().role === 'admin') {
                                    adminPanelLinkContainer.style.display = 'block';
                                }
                            } else if (role === 'admin') {
                                console.warn("Student Dashboard: Usuario es administrador, redirigiendo al panel de administración.");
                                window.location.href = 'admin.html';
                            } else {
                                console.warn("Student Dashboard: Rol de usuario desconocido. Cerrando sesión.");
                                await signOut(auth);
                                window.location.href = 'login.html';
                            }
                        } else {
                            console.warn("Student Dashboard: Documento de rol no encontrado. Cerrando sesión.");
                            await signOut(auth);
                            window.location.href = 'login.html';
                        }
                    } catch (error) {
                        console.error("Student Dashboard: Error al verificar el rol del usuario:", error);
                        await signOut(auth);
                        window.location.href = 'login.html';
                    }
                } else {
                    console.warn("Student Dashboard: No hay usuario autenticado. Redirigiendo a login.");
                    showAuthStatus('No hay sesión activa. Redirigiendo...', 'error');
                    window.location.href = 'login.html';
                }
            });

            // --- Carga de Cursos Inscritos en tiempo real ---
            const loadEnrolledCourses = (userId) => {
                console.log(`Cargando cursos inscritos para el usuario: ${userId}`);
                if (!db || !appId || !userId) {
                    console.warn("No se puede iniciar el listener de cursos inscritos. Firebase no inicializado o userId no disponible.");
                    loadingEnrolledCourses.style.display = 'none';
                    noEnrolledCourses.textContent = "Error al cargar tus cursos.";
                    noEnrolledCourses.style.display = 'block';
                    return;
                }

                const enrollmentsCollectionRef = collection(db, `/artifacts/${appId}/public/data/course_enrollments`);
                const q = query(enrollmentsCollectionRef, where("studentId", "==", userId));

                if (unsubscribeEnrollments) {
                    unsubscribeEnrollments(); // Desuscribirse del listener anterior si existe
                }

                unsubscribeEnrollments = onSnapshot(q, (querySnapshot) => {
                    enrolledCoursesList.innerHTML = ''; // Limpiar lista
                    loadingEnrolledCourses.style.display = 'none';

                    if (querySnapshot.empty) {
                        noEnrolledCourses.style.display = 'block';
                        return;
                    }
                    noEnrolledCourses.style.display = 'none';

                    querySnapshot.docs.forEach(doc => {
                        const enrollment = doc.data();
                        const courseDiv = document.createElement('div');
                        courseDiv.className = 'course-card';
                        courseDiv.innerHTML = `
                            <h4>${enrollment.courseName || 'Curso Desconocido'}</h4>
                            <p><strong>Estado de Inscripción:</strong> ${enrollment.status || 'Pendiente'}</p>
                            <p><strong>Fecha de Inscripción:</strong> ${enrollment.timestamp ? new Date(enrollment.timestamp.seconds * 1000).toLocaleDateString() : 'N/A'}</p>
                            <p>${enrollment.comments || ''}</p>
                        `;
                        enrolledCoursesList.appendChild(courseDiv);
                    });
                }, (error) => {
                    console.error("Error al escuchar cursos inscritos en tiempo real:", error);
                    loadingEnrolledCourses.style.display = 'none';
                    noEnrolledCourses.textContent = `Error al cargar tus cursos: ${error.message}`;
                    noEnrolledCourses.style.display = 'block';
                });
            };

            // --- Manejo del Logout ---
            logoutBtn.addEventListener('click', async () => {
                try {
                    if (auth.currentUser) {
                        await signOut(auth);
                        console.log("Student Dashboard: Sesión cerrada exitosamente.");
                        window.location.href = 'login.html';
                    }
                } catch (error) {
                    console.error("Student Dashboard: Error al cerrar sesión:", error);
                    alert("Error al cerrar sesión. Por favor, inténtalo de nuevo.");
                }
            });
        });
    </script>
</body>
</html>
